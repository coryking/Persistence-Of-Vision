; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[platformio]
; Set default environment to prevent building all envs on upload
default_envs = seeed_xiao_esp32s3

[env]
; Common platform/board configuration (all environments use same hardware)
platform = https://github.com/pioarduino/platform-espressif32/releases/download/stable/platform-espressif32.zip
board = seeed_xiao_esp32s3
framework = arduino
; Port assignment: LEFT USB-C port (near MagSafe) - MAC 30:30:F9:33:E4:60
upload_port = /dev/cu.usbmodem101
monitor_port = /dev/cu.usbmodem101
build_flags =
	'-D ARDUINO_USB_CDC_ON_BOOT=1'
	-I ../shared
lib_deps =
    ; Use coryking fork with ESP-IDF 5.5 fix (until upstream merges)
    https://github.com/coryking/NeoPixelBus.git#esp-idf-5.5-fix
    ; Use coryking fork with PROGMEM performance regression fix
    https://github.com/coryking/FastLED.git#fix/progmem-performance-regression
    wollewald/MPU9250_WE
; Validate correct device before upload (LED controller MAC address)
extra_scripts = pre:../tools/validate_device.py
custom_expected_mac = 30:30:F9:33:E4:60

[env:seeed_xiao_esp32s3]
; Standard optimized build
build_flags =
    ${env.build_flags}
    -O3 -ffast-math -finline-functions -funroll-loops

[env:seeed_xiao_esp32s3_profiling]
; Profiling build with pipeline profiler (queue-based analytics)
; Mutually exclusive with effect timing (effect_timing environment)
build_flags =
    ${env.build_flags}
    -O3 -ffast-math -finline-functions -funroll-loops
    ; Enable ESP_LOGD output (4=DEBUG, 5=VERBOSE)
    -DCORE_DEBUG_LEVEL=4
    ; Simulates rotation without hall sensor
    -DTEST_MODE
    ; Enables queue-based pipeline profiler
    -DENABLE_TIMING_INSTRUMENTATION
    ; TEMP: Re-enable effect timing to test if it fixes crash
    ; -DENABLE_EFFECT_TIMING
    ; Save assembly files for inspection
    -save-temps=obj

[env:seeed_xiao_esp32s3_effect_timing]
; Effect-specific timing (Radar breakdown, etc.)
; Mutually exclusive with pipeline profiling (profiling environment)
build_flags =
    ${env.build_flags}
    -O3 -ffast-math -finline-functions -funroll-loops
    ; Enable ESP_LOGD output (4=DEBUG, 5=VERBOSE)
    -DCORE_DEBUG_LEVEL=4
    ; Effect-specific timing (Radar, NoiseField, etc.)
    -DENABLE_EFFECT_TIMING
    ; Simulates rotation without hall sensor
    -DTEST_MODE


[env:seeed_xiao_esp32s3_fake_hall_sensor]
; Fake hall sensor (no spinning needed)
build_flags =
    ${env.build_flags}
    -O3 -ffast-math -finline-functions -funroll-loops
    ; Enable ESP_LOGD output (4=DEBUG, 5=VERBOSE)
    -DCORE_DEBUG_LEVEL=4
    ; Simulates rotation without hall sensor
    -DTEST_MODE


[env:seeed_xiao_esp32s3_debug]
; Debug build with maximum symbols and verbose logging
build_flags =
    ${env.build_flags}
    -DCORE_DEBUG_LEVEL=5
    -ggdb
    -gdwarf-4
    -fvar-tracking-assignments
    -fno-omit-frame-pointer
    -Og
    -g3
    -save-temps=obj
debug_tool = esp-builtin
debug_init_break = break setup
build_type = debug
